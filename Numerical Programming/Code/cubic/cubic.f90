!================================================================================================
! cubic.f90
! Justin Gabrielle A. Manay
! COMPHY2, Physics Department, De La Salle University
! This program calculates the roots of a cubic equation of the form a*x^3 + b*x^2 + c*x + d = 0
!================================================================================================

program cubic

    implicit none

    !--------------------------------------------------------------------------------------------
    ! Declare variables
    complex :: a, b, c, d, e, f, qr1, qr2, cr1, cr2, cr3, s, y1, y2, y3, x1, x2, x3
    !--------------------------------------------------------------------------------------------

    !--------------------------------------------------------------------------------------------
    ! User input
    write(*,*) "The cubic equation is of the form a*x^3 + b*x^2 + c*x + d"
    write(*,*) "Please specify your values for a, b, c and d in the form (real part, complex part)"
    write(*,*) "For example, (2,3) for 2 + 3*i"
    write(*, "(a4)", advance = "no") "a = "
    read(*,*) a
    write(*, "(a4)", advance = "no") "b = "
    read(*,*) b
    write(*, "(a4)", advance = "no") "c = "
    read(*,*) c
    write(*, "(a4)", advance = "no") "d = "
    read(*,*) d
    write(*,*)
    !--------------------------------------------------------------------------------------------

    !--------------------------------------------------------------------------------------------
    ! Calculate e and f
    e = (c/a) - (b**2/(3.0*a**2))
    f = (d/a) + ((2.0*b**3)/(27.0*a**3)) - ((b*c)/(3.0*a**2))
    !--------------------------------------------------------------------------------------------

    !--------------------------------------------------------------------------------------------
    ! Substitute to quadratic formula
    qr1 = -(f/2.0) + sqrt(f ** 2 / 4.0 + e ** 3 / 27.0)
    qr2 = -(f/2.0) - sqrt(f ** 2 / 4.0 + e ** 3 / 27.0)
    !--------------------------------------------------------------------------------------------

    !--------------------------------------------------------------------------------------------
    ! Use w = z^3 and get cube roots of one of the quadratic roots.
    call cube_root(qr1, cr1, cr2, cr3)
    !call cube_root(qr2, cr1, cr2, cr3)
    !--------------------------------------------------------------------------------------------

    !--------------------------------------------------------------------------------------------
    ! Use y = z + (s/z), where s = -e/3, to get y.
    s = -e/3.0
    y1 = cr1 + (s/cr1)
    y2 = cr2 + (s/cr2)
    y3 = cr3 + (s/cr3)
    !--------------------------------------------------------------------------------------------

    !--------------------------------------------------------------------------------------------
    ! Use x = y - (b/3*a) to get x.
    x1 = y1 - (b/(3.0*a))
    x2 = y2 - (b/(3.0*a))
    x3 = y3 - (b/(3.0*a))
    !--------------------------------------------------------------------------------------------

    !--------------------------------------------------------------------------------------------
    ! Print out results
    write(*,*) "The roots of the above cubic equation are: "

    if(imag(x1) < 0) then
        write(*,"(f15.10, 1x, a1, 1x, f15.10, 1x, a2)") real(x1), "-", -imag(x1), "*i"
    else
        write(*,"(f15.10, 1x, a1, 1x, f15.10, 1x, a2)") real(x1), "+", imag(x1), "*i"
    end if

    if(imag(x2) < 0) then
        write(*,"(f15.10, 1x, a1, 1x, f15.10, 1x, a2)") real(x2), "-", -imag(x2), "*i"
    else
        write(*,"(f15.10, 1x, a1, 1x, f15.10, 1x, a2)") real(x2), "+", imag(x2), "*i"
    end if

    if(imag(x3) < 0) then
        write(*,"(f15.10, 1x, a1, 1x, f15.10, 1x, a2)") real(x3), "-", -imag(x3), "*i"
    else
        write(*,"(f15.10, 1x, a1, 1x, f15.10, 1x, a2)") real(x3), "+", imag(x3), "*i"
    end if
    !--------------------------------------------------------------------------------------------

    contains
    !================================================================================================
    ! This subroutine finds the cube root of a complex number z and outputs the roots
    ! z1, z2 and z3.
    !================================================================================================
        subroutine cube_root(z, z1, z2, z3)
            implicit none
            !--------------------------------------------------------------------------------------------
            ! Declare variables
            complex, intent(in) :: z
            complex, intent (out) :: z1, z2, z3
            real*16 :: r, theta, r_cr, theta_cr1, theta_cr2, theta_cr3, PI

            PI = 4*atan(1.0)
            !--------------------------------------------------------------------------------------------

            !--------------------------------------------------------------------------------------------
            ! Express real(z) + imag(z) * i as r*e^(i*theta)
            ! Find r and theta
            r = sqrt(real(z) ** 2 + imag(z) ** 2)
            theta = atan2(imag(z), real(z))
            !--------------------------------------------------------------------------------------------

            !--------------------------------------------------------------------------------------------
            ! r*e^(i*theta) = r*e^(i * theta + 2*PI)
            ! Therefore, cube root of z = r^(1/3) * e^(i * (theta + 2*PI*j)/3) for j = 0, 1, 2
            r_cr = r ** (1.0/3.0)
            theta_cr1 = theta / 3
            theta_cr2 = (theta + 2*PI)/3
            theta_cr3 = (theta + 4*PI)/3
            !--------------------------------------------------------------------------------------------

            !--------------------------------------------------------------------------------------------
            ! Compute for cubic roots
            ! Express them as z = r*cos(theta) + r*sin(theta) * i
            z1 = complex(r_cr * cos(theta_cr1), r_cr * sin(theta_cr1))
            z2 = complex(r_cr * cos(theta_cr2), r_cr * sin(theta_cr2))
            z3 = complex(r_cr * cos(theta_cr3), r_cr * sin(theta_cr3))
            !--------------------------------------------------------------------------------------------

        end subroutine cube_root

end program cubic
